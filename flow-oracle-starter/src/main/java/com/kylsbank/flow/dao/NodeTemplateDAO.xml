<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kylsbank.flow.dao.NodeTemplateDAO">
	<sql id="whereClause">
		<if test="null != id">			
			<![CDATA[
				and t.ID = #{id}
			]]>
		</if>
		<if test="null != action">			
			<![CDATA[
				and t.ACTION = #{action}
			]]>
		</if>
		<if test="null != flowCode">			
			<![CDATA[
				and t.FLOW_CODE = #{flowCode}
			]]>
		</if>
		<if test="null != cascadeCode">			
			<![CDATA[
				and t.CASCADE_CODE = #{cascadeCode}
			]]>
		</if>
		<if test="null != roles">			
			<![CDATA[
				and t.ROLES = #{roles}
			]]>
		</if>
		<if test="null != nodeDesc">			
			<![CDATA[
				and t.NODE_DESC = #{nodeDesc}
			]]>
		</if>
		<if test="null != status">			
			<![CDATA[
				and t.STATUS = #{status}
			]]>
		</if>
		<if test="null != id and '' != id">
			<![CDATA[
				and t.ID = #{id}
			]]>
		</if>	
		<if test="null != idIn and '' != idIn">
			<![CDATA[
				and t.ID in (${idIn})
			]]>
		</if>

		<include refid="whereClauseExt"></include>
	</sql>

	<sql id="selectColumn">
		<trim suffixOverrides=",">
		<![CDATA[
			t.ID as id,t.ACTION as action,t.FLOW_CODE as flowCode,t.CASCADE_CODE as cascadeCode,t.ROLES as roles,t.NODE_DESC as nodeDesc,t.CREATE_TIME as createTime,t.UPDATE_TIME as updateTime,t.STATUS as status,
		]]>
		</trim>
	</sql>

	<select id="getSequence" resultType="long" useCache="false" flushCache="true">
		select F_NODE_TEMPLATE_seq.nextval from dual
	</select>

	<!-- 新增 -->
	<insert id="createBatch" parameterType="java.util.List">
		<![CDATA[
			insert all  
		]]>
	    <foreach collection="list" item="item"> 
	    	<![CDATA[
	    		into F_NODE_TEMPLATE ( 
	    	]]>
	    	<trim suffixOverrides=",">
			<![CDATA[
				ID,ACTION,FLOW_CODE,CASCADE_CODE,ROLES,NODE_DESC,
			]]>
			</trim>
			<![CDATA[	
				 ) values (
			]]>
			<trim suffixOverrides=",">
			<![CDATA[
				#{item.id, jdbcType=NUMERIC},#{item.action, jdbcType=NVARCHAR},#{item.flowCode, jdbcType=NVARCHAR},#{item.cascadeCode, jdbcType=NUMERIC},#{item.roles, jdbcType=NVARCHAR},#{item.nodeDesc, jdbcType=NVARCHAR},	
			]]>
			</trim>
			<![CDATA[	
				 )
			]]>
	    </foreach>
	    <![CDATA[
	    	select 1 from dual
	    ]]>
	</insert>

	<!-- 修改 -->
	<update id="update" parameterType="com.kylsbank.flow.bean.po.NodeTemplate">
		<![CDATA[
			update F_NODE_TEMPLATE set
		]]>	
		<trim suffixOverrides=",">
		<![CDATA[
			ID=#{id},						
			ACTION=#{action},						
			FLOW_CODE=#{flowCode},						
			CASCADE_CODE=#{cascadeCode},						
			ROLES=#{roles},						
			NODE_DESC=#{nodeDesc},						
			UPDATE_TIME=sysdate,						
		]]>
		</trim>
		<![CDATA[
			where ID = #{id}
		]]>
	</update>
	
	<!-- 更改(多个) -->
	<update id="updateBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";"> 
			<![CDATA[
				update "F_NODE_TEMPLATE"
			]]>
			<set>
				<trim suffixOverrides=",">
					<if test="null != item.id">	
						ID=#{item.id},
					</if>								
					<if test="null != item.action">	
						ACTION=#{item.action},
					</if>								
					<if test="null != item.flowCode">	
						FLOW_CODE=#{item.flowCode},
					</if>								
					<if test="null != item.cascadeCode">	
						CASCADE_CODE=#{item.cascadeCode},
					</if>								
					<if test="null != item.roles">	
						ROLES=#{item.roles},
					</if>								
					<if test="null != item.nodeDesc">	
						NODE_DESC=#{item.nodeDesc},
					</if>								
					UPDATE_TIME=sysdate,						
					<if test="null != item.status">	
						STATUS=#{item.status},
					</if>								
				</trim>
			</set>
			<![CDATA[
				where ID = #{item.id}
			]]>
		</foreach>
	</update>
	
	<!-- 更新 (通过参数) -->
	<update id="updateByArgs">
		<![CDATA[
			update F_NODE_TEMPLATE t
		]]>
		<set>
		<![CDATA[
			${setSql}
		]]>	
		UPDATE_TIME=sysdate,						
		</set>
		<where>
		<include refid="whereClause"></include>
		</where>
	</update>
	
	<!-- 删除 -->
	<delete id="deleteByIds">
		<![CDATA[
			delete from F_NODE_TEMPLATE 
			where ID in (${idIn})
		]]>
	</delete>
	
	<!-- 删除 (通过参数) -->
	<delete id="deleteByArgs" parameterType="map">
		<![CDATA[
			delete from F_NODE_TEMPLATE t
		]]>
		<where>
		<include refid="whereClause"></include>
		</where>
	</delete>

	<sql id="queryClause">
		<where>
		<include refid="whereClause"></include>
		<if test="null != withCalc and withCalc">
			<choose>
				<when test="null != actionKey and '' != actionKey and 'first' != actionKey and 'pre' != actionKey">
					<![CDATA[
						and r.action_key = #{actionKey}
					]]>
				</when>
				<otherwise>
					<![CDATA[
						and (r.action_key is null or r.action_key = '')
					]]>
				</otherwise>
			</choose>
		</if>
		<if test="null != currCode and '' != currCode">
			<![CDATA[
				and r.curr_code = #{currCode}
			]]>
		</if>
		<if test="null != nextCode and '' != nextCode">
			<![CDATA[
				and r.next_code = #{nextCode}
			]]>
		</if>
		</where>
        <choose>
	        <when test="null != orderField and '' != orderField">
	            <![CDATA[
					 order by ${orderField}
				]]>
	            <if test="null != orderDirection and '' != orderDirection">
	                <![CDATA[
						 ${orderDirection}
					]]>
	            </if>
	        </when>
	        <when test="null == noOrderField or '' == noOrderField">
	            <![CDATA[
				 order by t.ID
			    ]]>
			    <choose>
					<when test="null != orderDirection and '' != orderDirection">
					<![CDATA[
						 ${orderDirection}
					]]>
					</when>
					<otherwise>
					<![CDATA[
						 desc
					]]>
					</otherwise>
				</choose>
	        </when>   
	    </choose>
    </sql>

	
	<!-- 获取全部 -->
	<select id="queryByArgs" parameterType="java.util.Map" resultType="com.kylsbank.flow.bean.po.NodeTemplate">
		<if test="null != limit">
            <![CDATA[
			  SELECT * FROM (SELECT A.*, ROWNUM RN FROM ( 
		    ]]>
        </if>
		<![CDATA[
			select
		]]>
		<choose>
			<when test="null != fieldSQL and '' != fieldSQL">
				${fieldSQL}
			</when>
			<otherwise>
				<include refid="selectColumn"></include>
				<if test="null != withCalc and withCalc">
					<choose>
						<when test="null != actionKey and 'pre' == actionKey">
						<![CDATA[
							, r.calc as calc
						]]>
						</when>
						<otherwise>
						<![CDATA[
							, n.calc as calc
					    ]]>
						</otherwise>
					</choose>
				</if>
			</otherwise>
		</choose>		
		<![CDATA[	 
			from F_NODE_TEMPLATE t  
		]]>
		<if test="null != withCalc and withCalc">
			<choose>
				<when test="null != actionKey and 'pre' == actionKey">
					<![CDATA[
						left join f_node_template_ref r on t.flow_code = r.flow_code and t.cascade_code = r.curr_code and r.flow_code = #{flowCode}
				    ]]>
				</when>
				<otherwise>
					<![CDATA[
						left join f_node_template_ref r on t.flow_code = r.flow_code and t.cascade_code = r.next_code and r.flow_code = #{flowCode}
						LEFT JOIN (
							select flow_code, curr_code, LISTAGG(calc, ',') WITHIN GROUP(ORDER BY ID) AS calc from f_node_template_ref
							where flow_code = #{flowCode} group by flow_code, curr_code
						) n ON r.flow_code = n.flow_code and r.next_code = n.curr_code and n.flow_code = #{flowCode}
				    ]]>
				</otherwise>
			</choose>
		</if>
		<include refid="queryClause"></include>
		<if test="null != limit">
            <![CDATA[
			  	) A WHERE ROWNUM <= (#{start} + #{limit})) WHERE RN > #{start}
		    ]]>
        </if>
        <if test="null != sqlTail and '' != sqlTail">
            <![CDATA[
                ${sqlTail}
            ]]>
        </if>
	</select>
	
	<!-- 获取数目 -->
	<select id="countByArgs" parameterType="java.util.Map" resultType="long">
		<![CDATA[
			select count(1) from F_NODE_TEMPLATE t  
		]]>
		<where>
		<include refid="whereClause"></include>
		</where>
		<if test="null != sqlTail and '' != sqlTail">
            <![CDATA[
                ${sqlTail}
            ]]>
        </if>
	</select>
</mapper>
